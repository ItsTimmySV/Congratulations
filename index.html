<!DOCTYPE html>
<html>
<head>
<base href="https://www.gpsshare.com/app/">
<title>GPS Compartido en Tiempo Real - Mostrar en Mapa</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
  body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: Arial, sans-serif;
  }
  #map {
    height: 100vh;
    width: 100%;
  }
  #shareButton {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 10px 20px;
    font-size: 16px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
    z-index: 1000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  #shareButton:hover {
    background-color: #45a049;
  }
  .user-marker {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    background-color: #3388ff;
    border: 2px solid white;
    border-radius: 50%;
    color: white;
    font-weight: bold;
  }
  #permissionModal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  .modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 5px;
    text-align: center;
  }
  #allowButton, #denyButton {
    margin: 10px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
  }
  #allowButton {
    background-color: #4CAF50;
    color: white;
    border: none;
  }
  #denyButton {
    background-color: #f44336;
    color: white;
    border: none;
  }
  #userCounter {
    position: fixed;
    top: 10px;
    right: 10px;
    background-color: rgba(255, 255, 255, 0.8);
    padding: 10px;
    border-radius: 5px;
    font-size: 16px;
    z-index: 1000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
</style>
</head>
<body>
<div id="map"></div>
<button id="shareButton">Compartir mi ubicación</button>
<div id="userCounter">Usuarios compartiendo: 0</div>

<div id="permissionModal">
  <div class="modal-content">
    <h2>Permiso de ubicación</h2>
    <p>Esta aplicación necesita acceso a tu ubicación para mostrarla en el mapa. ¿Permites que accedamos a tu ubicación?</p>
    <button id="allowButton">Permitir</button>
    <button id="denyButton">Denegar</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCE2DEInNal6VIEk8rW7oluVKV3Mv9e-TQ",
  authDomain: "gps-89685.firebaseapp.com",
  projectId: "gps-89685",
  storageBucket: "gps-89685.appspot.com",
  messagingSenderId: "850380730343",
  appId: "1:850380730343:web:35d065df67b39ef7b81742"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

const map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

const markers = {};
let myUserId = null;
let watchId = null;
let isSharing = false;
let lastKnownPosition = null;

function generateUserId() {
  return 'user_' + Math.random().toString(36).substr(2, 9);
}

function updateLocation(position) {
  const { latitude, longitude } = position.coords;
  lastKnownPosition = { latitude, longitude };
  
  if (!myUserId) {
    myUserId = generateUserId();
  }
  
  database.ref('locations/' + myUserId).set({
    latitude,
    longitude,
    timestamp: Date.now()
  });

  updateMarker(myUserId, latitude, longitude);
}

function updateMarker(userId, latitude, longitude) {
  if (markers[userId]) {
    markers[userId].setLatLng([latitude, longitude]);
  } else {
    const userMarker = L.divIcon({
      className: 'user-marker',
      html: `<span>${userId.slice(-2)}</span>`
    });
    markers[userId] = L.marker([latitude, longitude], { icon: userMarker }).addTo(map);
  }
}

function removeMarker(userId) {
  if (markers[userId]) {
    map.removeLayer(markers[userId]);
    delete markers[userId];
  }
}

function updateUserCounter(count) {
  document.getElementById('userCounter').textContent = `Usuarios compartiendo: ${count}`;
}

// Listener para el contador de usuarios en tiempo real
database.ref('locations').on('value', (snapshot) => {
  const userCount = snapshot.numChildren();
  updateUserCounter(userCount);
});

database.ref('locations').on('child_added', (snapshot) => {
  const userId = snapshot.key;
  const { latitude, longitude } = snapshot.val();
  updateMarker(userId, latitude, longitude);
});

database.ref('locations').on('child_changed', (snapshot) => {
  const userId = snapshot.key;
  const { latitude, longitude } = snapshot.val();
  updateMarker(userId, latitude, longitude);
});

database.ref('locations').on('child_removed', (snapshot) => {
  const userId = snapshot.key;
  removeMarker(userId);
});

function shareLocationRealTime() {
  if ("geolocation" in navigator) {
    watchId = navigator.geolocation.watchPosition(updateLocation, handleLocationError, {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 5000
    });
    isSharing = true;
    document.getElementById('shareButton').textContent = 'Dejar de compartir';
  } else {
    alert("Tu navegador no soporta geolocalización.");
  }
}

function handleLocationError(error) {
  console.error("Error al obtener la ubicación:", error);
  if (lastKnownPosition) {
    updateLocation(lastKnownPosition);
  } else {
    alert("No se pudo obtener tu ubicación. Por favor, verifica los permisos de tu navegador.");
  }
}

function stopSharingLocation() {
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  if (myUserId) {
    database.ref('locations/' + myUserId).remove()
      .then(() => {
        removeMarker(myUserId);
        myUserId = null;
        isSharing = false;
        lastKnownPosition = null;
        document.getElementById('shareButton').textContent = 'Compartir mi ubicación';
      })
      .catch((error) => {
        console.error("Error al eliminar la ubicación de la base de datos:", error);
      });
  }
}

function showPermissionModal() {
  document.getElementById('permissionModal').style.display = 'block';
}

function hidePermissionModal() {
  document.getElementById('permissionModal').style.display = 'none';
}

function handlePermissionGranted() {
  hidePermissionModal();
  shareLocationRealTime();
}

function handlePermissionDenied() {
  hidePermissionModal();
  alert("No se puede compartir tu ubicación sin los permisos necesarios.");
}

document.getElementById('shareButton').addEventListener('click', () => {
  if (isSharing) {
    stopSharingLocation();
  } else {
    showPermissionModal();
  }
});

document.getElementById('allowButton').addEventListener('click', handlePermissionGranted);
document.getElementById('denyButton').addEventListener('click', handlePermissionDenied);

navigator.geolocation.getCurrentPosition((position) => {
  const { latitude, longitude } = position.coords;
  map.setView([latitude, longitude], 13);
}, () => {
  console.log("No se pudo obtener la ubicación inicial del usuario.");
});

window.addEventListener('beforeunload', () => {
  stopSharingLocation();
});
</script>
</body>
</html>