<!DOCTYPE html>
<html>
<head>
<base href="https://www.gpsshare.com/app/">
<title>GPS Compartido en Tiempo Real - Mostrar en Mapa</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
  body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: Arial, sans-serif;
  }
  #map {
    height: 90vh;
    width: 100%;
  }
  #shareButton {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 10px 20px;
    font-size: 16px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  #shareButton:hover {
    background-color: #45a049;
  }
  .user-marker {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    background-color: #3388ff;
    border: 2px solid white;
    border-radius: 50%;
    color: white;
    font-weight: bold;
  }
  #permissionModal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  .modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 5px;
    text-align: center;
  }
  #allowButton, #denyButton {
    margin: 10px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
  }
  #allowButton {
    background-color: #4CAF50;
    color: white;
    border: none;
  }
  #denyButton {
    background-color: #f44336;
    color: white;
    border: none;
  }
</style>
</head>
<body>
<div id="map"></div>
<button id="shareButton">Compartir mi ubicación</button>

<div id="permissionModal">
  <div class="modal-content">
    <h2>Permiso de ubicación</h2>
    <p>Esta aplicación necesita acceso a tu ubicación para mostrarla en el mapa. ¿Permites que accedamos a tu ubicación?</p>
    <button id="allowButton">Permitir</button>
    <button id="denyButton">Denegar</button>
  </div>
</div>

<script>
// Configuración de Firebase (reemplaza con tus propias credenciales)
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "your-app.firebaseapp.com",
  databaseURL: "https://your-app.firebaseio.com",
  projectId: "your-project-id",
  storageBucket: "your-app.appspot.com",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Inicializar el mapa
const map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

const markers = {};
let myUserId = null;
let watchId = null;
let isSharing = false;

// Función para generar un ID de usuario único
function generateUserId() {
  return 'user_' + Math.random().toString(36).substr(2, 9);
}

// Función para actualizar la ubicación del usuario
function updateLocation(position) {
  const { latitude, longitude } = position.coords;
  
  if (!myUserId) {
    myUserId = generateUserId();
  }
  
  database.ref('locations/' + myUserId).set({
    latitude,
    longitude,
    timestamp: Date.now()
  });

  // Actualizar el marcador inmediatamente
  updateMarker(myUserId, latitude, longitude);
}

// Función para actualizar el marcador en el mapa
function updateMarker(userId, latitude, longitude) {
  if (markers[userId]) {
    markers[userId].setLatLng([latitude, longitude]);
  } else {
    const userMarker = L.divIcon({
      className: 'user-marker',
      html: `<span>${userId.slice(-2)}</span>`
    });
    markers[userId] = L.marker([latitude, longitude], { icon: userMarker }).addTo(map);
  }

  // Si es mi marcador, centrar el mapa en él
  if (userId === myUserId) {
    map.setView([latitude, longitude], 13);
  }
}

// Escuchar cambios en la base de datos
database.ref('locations').on('value', (snapshot) => {
  snapshot.forEach((childSnapshot) => {
    const userId = childSnapshot.key;
    const { latitude, longitude } = childSnapshot.val();
    updateMarker(userId, latitude, longitude);
  });
});

// Función para compartir ubicación en tiempo real
function shareLocationRealTime() {
  if ("geolocation" in navigator) {
    watchId = navigator.geolocation.watchPosition(updateLocation, (error) => {
      console.error("Error al obtener la ubicación:", error);
      alert("No se pudo obtener tu ubicación. Por favor, verifica los permisos de tu navegador.");
    }, {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 5000
    });
    isSharing = true;
    document.getElementById('shareButton').textContent = 'Dejar de compartir';
  } else {
    alert("Tu navegador no soporta geolocalización.");
  }
}

// Función para dejar de compartir la ubicación
function stopSharingLocation() {
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  if (myUserId) {
    database.ref('locations/' + myUserId).remove();
    if (markers[myUserId]) {
      map.removeLayer(markers[myUserId]);
      delete markers[myUserId];
    }
  }
  isSharing = false;
  document.getElementById('shareButton').textContent = 'Compartir mi ubicación';
}

// Función para mostrar el modal de permiso
function showPermissionModal() {
  document.getElementById('permissionModal').style.display = 'block';
}

// Función para ocultar el modal de permiso
function hidePermissionModal() {
  document.getElementById('permissionModal').style.display = 'none';
}

// Función para manejar la concesión de permisos
function handlePermissionGranted() {
  hidePermissionModal();
  shareLocationRealTime();
}

// Función para manejar la denegación de permisos
function handlePermissionDenied() {
  hidePermissionModal();
  alert("No se puede compartir tu ubicación sin los permisos necesarios.");
}

// Evento de clic para solicitar permisos y compartir ubicación
document.getElementById('shareButton').addEventListener('click', () => {
  if (isSharing) {
    stopSharingLocation();
  } else {
    showPermissionModal();
  }
});

// Eventos para los botones del modal
document.getElementById('allowButton').addEventListener('click', handlePermissionGranted);
document.getElementById('denyButton').addEventListener('click', handlePermissionDenied);

// Centrar el mapa en la ubicación del usuario al cargar (si se tienen los permisos)
navigator.geolocation.getCurrentPosition((position) => {
  const { latitude, longitude } = position.coords;
  map.setView([latitude, longitude], 13);
}, () => {
  console.log("No se pudo obtener la ubicación inicial del usuario.");
});

// Limpiar el watchPosition cuando el usuario cierra la página
window.addEventListener('beforeunload', () => {
  stopSharingLocation();
});
</script>
</body>
</html>